<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../bower_components/google-map/google-map.html">
<link rel="import" href="../bower_components/google-apis/google-maps-api.html">
<script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier/1.0.3/oms.min.js"></script>
<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>

<dom-module id="my-view1">
  <template>
    <style include="shared-styles">
       :host {
        display: block;

        padding: 10px;
      }

      #map {
        z-index: 1;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }
    </style>

    <google-map disable-default-ui id="map" map="{{map}}" latitude="0" longitude="0" zoom="2" api-key="AIzaSyBFRdnjO9WVvl3Voqj84bLvVMVIjDfBjlk">
    </google-map>
  </template>

  <script>
    class MyView1 extends Polymer.Element {
      static get is() { return 'my-view1'; }

      static get properties() {
        return {
          commits: {
            type: Object,
            value: [],
            observer: 'commitsChanged'
          },
          map: {
            type: Object,
            notify: true
          },
          apiLoaded: {
            type: Boolean,
            notify: true,
            value: false
          },
          from: {
            type: String,
            notify: true
          },
          till:{
            type: String,
            notify: true
          }
        };
      }

      ready() {
        super.ready();
        this.getCommits();
        document.addEventListener('api-load', (e) => {
          this.apiLoaded = true;
          this.commitsChanged();
        }, {
            once: true
          });
      }

      getCommits() {
        console.log("this: ', thi", new Date(this.from));
        console.log("this: ', till",new Date(this.till));
        fetch('http://localhost:8081/v1/commits/list', {
          method: 'post',
          headers: {
            'Accept': 'application/json, text/plain, */*',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            "from": new Date(this.from),
            "till": new Date(this.till),
            "limit": 10000
          })
        }).then(res => res.json())
          .then(res => {
            console.log(res);
            this.commits = res;
          });
      }

      commitsChanged() {
        if (!this.apiLoaded) {
          return;
        }
        this.addMarkers();
        this.addLines();
      }

      addMarkers() {
        var oms = new OverlappingMarkerSpiderfier(this.map, {
          markersWontMove: true,
          markersWontHide: true,
          basicFormatEvents: true
        });

        let markers = [];
        for (var i = 0; i < this.commits.length; i++) {
          let myLatlng = new google.maps.LatLng(this.commits[i].author.location.lat, this.commits[i].author.location.lng);
          let marker = new google.maps.Marker({
            position: myLatlng,
            pixel: this.commits[i],
            title: this.commits[i].author.login
          });
          markers.push(marker);
          let markerContent = this.commits[i];
          google.maps.event.addListener(marker, 'spider_click', function test(e) {  // 'spider_click', not plain 'click'
            let iw = new google.maps.InfoWindow();
            let content = "Author: " + markerContent.author.login + "<br/>";
            content += "Sha: " + markerContent.sha + "<br/>";
            content += "Message: " + markerContent.message;
            iw.setContent(content);
            iw.open(this.map, marker);
          });

          oms.addMarker(marker)
        }
        var markerCluster = new MarkerClusterer(this.map, markers,
          { imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m' });
        markerCluster.setMaxZoom(10);
      }

      addLines() {

        var collaborationCoordinates = [
        ];
        for (var i = 0; i < this.commits.length; i++) {
          collaborationCoordinates.push({ lat: this.commits[i].author.location.lat, lng: this.commits[i].author.location.lng })
        }

        var flightPath = new google.maps.Polyline({
          path: collaborationCoordinates,
          geodesic: true,
          strokeColor: '#3423A6',
          strokeOpacity: 1.0,
          strokeWeight: 2
        });
        flightPath.setMap(this.map);
      }
    }

    window.customElements.define(MyView1.is, MyView1);
  </script>
</dom-module>