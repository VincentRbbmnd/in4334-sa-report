<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../bower_components/google-map/google-map.html">
<link rel="import" href="../bower_components/google-apis/google-maps-api.html">
<link rel="import" href="custom-timeline.html">
<script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier/1.0.3/oms.min.js"></script>
<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>

<dom-module id="my-view1">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        height: calc(100vh - 64px);
        background-color: white;
      }

      #wrapper {
        position: relative;
        height: 600px;
      }

      #map {
        z-index: 1;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }
    </style>
    <div class="layout vertical">
      <div id="timeline">
        <custom-timeline></custom-timeline>
      </div>
      <div id="wrapper">
        <google-map disable-default-ui id="map" map="{{map}}" latitude="0" longitude="0" zoom="2" api-key="AIzaSyBFRdnjO9WVvl3Voqj84bLvVMVIjDfBjlk">
        </google-map>
      </div>

    </div>


  </template>

  <script>
    class MyView1 extends Polymer.Element {
      static get is() {
        return 'my-view1';
      }

      static get properties() {
        return {
          commits: {
            type: Object,
            value: [],
            observer: 'commitsChanged',
            notify: true
          },
          map: {
            type: Object,
            notify: true
          },
          apiLoaded: {
            type: Boolean,
            notify: true,
            value: false
          },
          from: {
            type: String,
            notify: true,
            observer: '_timeChanged'
          },
          till: {
            type: String,
            notify: true,
            observer: '_timeChanged'
          },
          markers: {
            type: Object,
            notify: true,
            value: []
          },
          oms: {
            type: Object,
            notify: true,
            value: {}
          },
          markerCluster: {
            type: Object,
            notify: true,
            value: {}
          },
          commitPath: {
            type: Object,
            notify: true,
            value: {}
          },
          collaborationCoordinates: {
            type: Object,
            notify: true,
            value: []
          },
          markerClusterDone: {
            type: Boolean,
            notify: true,
            value: false
          },
          name: {
            type: String
          },
          page: {
            type: String
          },
          selectedProject: {
            type: String,
            notify: true,
            observer: '_selectedProjectChanged'
          },
        };
      }

      constructor() {
        super();
      }

      ready() {
        super.ready();
        document.addEventListener('api-load', (e) => {
          this._setMapElement();

          this.oms = new OverlappingMarkerSpiderfier(this.map, {
            markersWontMove: true,
            markersWontHide: true,
            basicFormatEvents: true
          });

          this.commitPath = new google.maps.Polyline({
            path: this.collaborationCoordinates,
            geodesic: true,
            strokeColor: '#3423A6',
            strokeOpacity: 1.0,
            strokeWeight: 2
          });

          this.markerCluster = new MarkerClusterer(this.map, [], {
            imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'
          });
          this.markerCluster.setMaxZoom(14);
          this.apiLoaded = true;
          this.commitsChanged();
        }, {
            once: true
          });
      }

      _setMapElement() {
        console.log(this.$.timeline.offsetHeight)
        console.log(this.offsetHeight);
        this.$.wrapper.style.height = this.offsetHeight - this.$.timeline.offsetHeight + "px";

      }

      _selectedProjectChanged() {
        this.getCommits(this.selectedProject.id);
      }

      _timeChanged(time) {
        if (this.selectedProject === undefined) {
          return;
        }
        if (time && this.name == this.page) {
          this.getCommits(this.selectedProject.id);
        }
      }

      getCommits(projectID) {
        fetch('http://localhost:8081/v1/repositories/' + projectID + '/commits/list?from=' + new Date(this.from).toISOString() +
          '&until=' +
          new Date(this.till).toISOString()).then((response) => {
            return response.json();
          }).then((resp) => {
            console.log("resp", resp);
            this.commits = resp;
          });
      }

      commitsChanged() {
        if (!this.apiLoaded) {
          return;
        }
        this.addMarkers();
        this.addLines();
      }

      addMarkers() {
        for (var i = 0; i < this.markers.length; i++) {
          this.oms.removeMarker(this.markers[i]);
        }
        this.markers = [];
        if (!this.commits) {
          return;
        }
        for (var i = 0; i < this.commits.length; i++) {
          let myLatlng = new google.maps.LatLng(this.commits[i].author.location.lat, this.commits[i].author.location
            .lng);
          var image = {
            url: '../images/icons/git-commit.png',
            // This marker is 20 pixels wide by 32 pixels high.
            scaledSize: new google.maps.Size(20, 20),
            // // The origin for this image is (0, 0).
            origin: new google.maps.Point(0, 0),
            // // The anchor for this image is the base of the flagpole at (0, 32).
            anchor: new google.maps.Point(10, 10)
          };
          let marker = new google.maps.Marker({
            position: myLatlng,
            pixel: this.commits[i],
            title: this.commits[i].author.login,
            icon: image
          });
          this.markers.push(marker);
          let markerContent = this.commits[i];
          google.maps.event.addListener(marker, 'spider_click', function test(e) { // 'spider_click', not plain 'click'
            let iw = new google.maps.InfoWindow();
            let content = "Author: " + markerContent.author.login + "<br/>";
            content += "Sha: " + markerContent.sha + "<br/>";
            content += "Message: " + markerContent.message;
            iw.setContent(content);
            iw.open(this.map, marker);
          });

          this.oms.addMarker(marker)
        }
        this.markerCluster.clearMarkers();
        this.markerCluster.addMarkers(this.markers);
      }

      addLines() {
        this.commitPath.setMap(null);
        this.collaborationCoordinates = [];
        if (!this.commits) {
          return;
        }
        for (var i = 0; i < this.commits.length; i++) {
          this.collaborationCoordinates.push({
            lat: this.commits[i].author.location.lat,
            lng: this.commits[i].author.location.lng
          })
        }
        this.commitPath = new google.maps.Polyline({
          path: this.collaborationCoordinates,
          geodesic: true,
          strokeColor: '#3423A6',
          strokeOpacity: 1.0,
          strokeWeight: 2
        });

        this.commitPath.setMap(this.map);
      }
    }

    window.customElements.define(MyView1.is, MyView1);
  </script>
</dom-module>