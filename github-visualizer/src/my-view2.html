<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="custom-timeline.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<script src="..\node_modules\d3\build\d3.min.js"></script>
<script src="..\node_modules\d3-queue\build\d3-queue.min.js"></script>
<script src="..\node_modules\d3-request\build\d3-request.min.js"></script>
<script src="..\node_modules\topojson\dist\topojson.min.js"></script>

<dom-module id="my-view2">
  <template>
    <style include="shared-styles iron-flex iron-flex-alignment">
       :host {
          display: block;
          width: 100%;
        height: calc(100vh - 64px);
        }

        #sliderContainer {
          text-align: center;
          position: relative;
          top: 800px;
        }

        #svg {
          z-index: 1;
          position: absolute;
          top: 170px;
          left: 0;
          right: 0;
          bottom: 0;
        }
    </style>
    <div class="layout vertical">
        <custom-timeline id="timeLine" till-date="{{till}}" from-date="{{from}}"></custom-timeline>
    <svg id="svg" width="1200" height="850"></svg>
    
    </div>
        

    <!-- <div id="sliderContainer">
      <input id="timeslide" type="range" min="0" max="11" value="0" step="1"/><br>
      <span id="range">January</span>
    </div> -->
  </template>

  <script>
    class MyView2 extends Polymer.Element {
      static get is() { return 'my-view2'; }

      static get properties() {
        return {
          commits: {
            type: Object,
            value: [],
            observer: 'commitsChanged'
          },
          apiLoaded: {
            type: Boolean,
            notify: true,
            value: false
          },
          from: {
            type: String,
            notify: true,
            observer: '_timeChanged'
          },
          till: {
            type: String,
            notify: true,
            observer: '_timeChanged'
          },
          name: {
            type: String
          },
          page: {
            type: String
          },
          svg: {
            type: Object
          },
          projection: {
            type: Function
          },
          path: {
            type: Object
          },
          selectedProject: {
            type: String,
            notify: true,
            observer: '_selectedProjectChanged'
          }
        };
      }

      ready() {
        super.ready();
        this.drawMap();
      }

      initialDate(d,i){
        const month = ["January","February","March","April","May","June","July","August","September","October","November","December"]
        var d = new Date(d.timestamp);
        var m = month[d.getMonth()];
        if (m == "January") {
            this.parentElement.appendChild(this);
            return "red";
        } else {
            return "#999";
        };
      }

      _timeChanged(time) {
        if (this.selectedProject === undefined) {
          return;
        }
        if (time) {
          this._debounceFilter = Polymer.Debouncer.debounce(this._debounceFilter, Polymer.Async.timeOut.after(500), () => {
            this.getCommits(this.selectedProject.id);
          });
        }
      }

      _selectedProjectChanged() {
        if (this.selectedProject === null) {
          return;
        }
        this.getCommits(this.selectedProject.id);
      }

      getCommits(projectID) {
        fetch('http://localhost:8081/v1/repositories/' + this.selectedProject.id + '/commits/list?from=' + new Date(this.from).toISOString() +
          '&until=' +
          new Date(this.till).toISOString()).then((response) => {
            return response.json();
          }).then((resp) => {
            console.log("resp: ", resp);
            this.commits = resp;
          });
      }

      commitsChanged() {
        console.log( "commits changed" )
        if( this.svg ){
          let commitNodes = this.svg.selectAll("circle")
                                    .data(this.commits)

          var that = this

          commitNodes.enter()
              .append("circle")
              .attr( "class", "commit")
              .attr("cx", function (d) {
                  let lat = d.author.location.lat;
                  let lon = d.author.location.lng
                  return that.projection([lon, lat])[0];
              })
              .attr("cy", function (d) {
                let lat = d.author.location.lat;
                let lon = d.author.location.lng
                  return that.projection([lon, lat])[1];
              })
              .attr("r", "2px")
              .attr("fill", this.initialDate)

          commitNodes.exit()
                      .remove()
        }

      }

      drawMap() {
        console.log("Starting to make requests...")

        const margin = {top: 20, right: 20, bottom: 30, left: 40}
        const padding = 30
        const width = 1500 - margin.left - margin.right
        const height = 750 - margin.top - margin.bottom

        this.svg = d3.select(this.$.svg)
                    .attr( 'width', 1500 )
                    .attr( 'height', 750 )

        this.projection = d3.geoMercator()
                            .scale(150)
                            .translate( [width / 2, height / 1.5]);

        this.path = d3.geoPath().projection(this.projection);

        let d3Ready = (error, world) => {
            if (error) throw error;
    
            // const commits = commitsResponse
            // console.log(commitsResponse);
            // console.log("commits: ", commits)
    
            var inputValue = null;
            const month = ["January","February","March","April","May","June","July","August","September","October","November","December"]
    
            // when the input range changes update the value
            d3.select(this.$.timeslide).on("input", function() {
                update(+this.value);
            });
    
            // update the fill of each SVG of class "commit" with value
            let update = (value) => {
              this.$.range.innerHTML=month[value];
              inputValue = month[value];
              d3.selectAll(this.shadowRoot.querySelectorAll('.commit'))
                  .attr("fill", dateMatch);
            }
    
            function dateMatch(data, value) {
              var d = new Date(data.timestamp);
              var m = month[d.getMonth()];
              if (inputValue == m) {
                  this.parentElement.appendChild(this);
                  return "red";
              } else {
                  return "#999";
              };
            }
    
            this.svg.append("g")
                .attr("class", "countries")
                .selectAll("path")
                .data(topojson.feature(world, world.objects.countries).features)
                .enter().append("path")
                .attr("d", this.path)
                .style("fill", "white")
                .style("stroke", "black")

            console.log("this.commits: ", this.commits)

            let commitNodes = this.svg.selectAll("circle")
                                  .data(this.commits)
    
            var that = this

            commitNodes.enter()
                .append("circle")
                .attr( "class", "commit")
                .attr("cx", function (d) {
                    let lat = d.author.location.lat
                    let lon = d.author.location.lng
                    return that.projection([lon, lat])[0]
                })
                .attr("cy", function (d) {
                  let lat = d.author.location.lat
                  let lon = d.author.location.lng
                  return that.projection([lon, lat])[1]
                })
                .attr("r", "2px")
                .attr("fill", this.initialDate)

            commitNodes.exit()
                        .remove()
        }

        d3.queue()
          .defer( d3.json, "world-50m.json" )
          .await( d3Ready )

      }
    }

    window.customElements.define(MyView2.is, MyView2);
  </script>
</dom-module>
